#!/bin/bash

rm -f table_*.csv

# Where to collect raw files as out_0, out_1, ...
DEST_DIR="collected_files"
rm -rf "$DEST_DIR"
mkdir -p "$DEST_DIR"

# Global counter for out_0, out_1, ... across all iterations
COUNTER=0

for KNUDSEN in 0.0015103054493884667 0.0017368512667967366 0.0019973789568162466 0.0022969858003386834 0.0026415336703894863 0.0030377637209479088 0.0034934282790900946 0.004017442520953609 0.00462005889909665 0.0053130677339611465 0.006110027894055318 0.007026532078163616 0.008080511889888158 0.00929258867337138 0.010686476974377086 0.012289448520533649 0.014132865798613696 0.016252795668405748 0.018690715018666607 0.021494322271466595 0.024718470612186585 0.02842624120401457 0.032690177384616756 0.03759370399230927 0.043232759591155655 0.049717673529829 0.05717532455930333 0.06575162324319883 0.07561436672967865 0.08695652173913045 0.1 0.11499999999999999 0.13224999999999998 0.15208749999999996 0.17490062499999995 0.20113571874999994 0.2313060765624999 0.26600198804687486 0.3059022862539061 0.35178762919199197 0.4045557735707907 0.4652391396064093 0.5350250105473706 0.6152787621294762 0.7075705764488975 0.8137061629162322 0.9357620873536668 1.0761264004567168 1.2375453605252242 1.4231771646040077 1.636653739294609 1.8821518001888 2.1644745702171195 2.4891457557496874 2.8625176191121406 3.2918952619789614 3.7856795512758055 4.353531483967176 5.006561206562252 5.757545387546589 6.621177195678577
do
  # for I in 0 1 2 3 4
  for I in 0
  do
    FILE="results_rotating_cavity${KNUDSEN}/kinetic_energy_velocity_${I}"
    FILE_U_XDMF="results_rotating_cavity${KNUDSEN}/u_${I}.xdmf"
    FILE_U_H5="results_rotating_cavity${KNUDSEN}/u_${I}.h5"
    FILE_THETA_XDMF="results_rotating_cavity${KNUDSEN}/theta_${I}.xdmf"
    FILE_THETA_H5="results_rotating_cavity${KNUDSEN}/theta_${I}.h5"
    FILE_S_XDMF="results_rotating_cavity${KNUDSEN}/s_${I}.xdmf"
    FILE_S_H5="results_rotating_cavity${KNUDSEN}/s_${I}.h5"
    if [ -f "$FILE" ]; then
      KINETIC_ENERGY_VELOCITY=$(cat "$FILE")
      echo "$KNUDSEN, $KINETIC_ENERGY_VELOCITY" >> "table_${I}.csv"

      # Also copy the source FILE into a separate folder as out_0, out_1, ...
      mkdir -p "$DEST_DIR"
      cp "$FILE_U_XDMF" "${DEST_DIR}/u_${COUNTER}.xdmf"
      cp "$FILE_U_H5" "${DEST_DIR}/u_${COUNTER}.h5"
      cp "$FILE_THETA_XDMF" "${DEST_DIR}/theta_${COUNTER}.xdmf"
      cp "$FILE_THETA_H5" "${DEST_DIR}/theta_${COUNTER}.h5"
      cp "$FILE_S_XDMF" "${DEST_DIR}/s_${COUNTER}.xdmf"
      cp "$FILE_S_H5" "${DEST_DIR}/s_${COUNTER}.h5"
      bash replace_u_index.sh "${DEST_DIR}/u_${COUNTER}.xdmf" "u_0" "u_${COUNTER}" "${COUNTER}"
      bash replace_u_index.sh "${DEST_DIR}/theta_${COUNTER}.xdmf" "theta_0" "theta_${COUNTER}" "${COUNTER}"
      bash replace_u_index.sh "${DEST_DIR}/s_${COUNTER}.xdmf" "s_0" "s_${COUNTER}" "${COUNTER}"
      COUNTER=$((COUNTER + 1))
    else
      echo "WARN: Missing $FILE" >&2
    fi
  done
done

# Preview first table
[ -f table_0.csv ] && cat table_0.csv
